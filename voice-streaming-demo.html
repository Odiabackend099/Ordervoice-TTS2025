<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultra-Low Latency Voice Streaming Demo - OrderVoice</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 40px;
      font-size: 16px;
    }

    .status-card {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .status-row:last-child {
      margin-bottom: 0;
    }

    .status-label {
      color: #4a5568;
      font-weight: 500;
    }

    .status-value {
      color: #2d3748;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #cbd5e0;
    }

    .status-dot.connected {
      background: #48bb78;
      box-shadow: 0 0 10px rgba(72, 187, 120, 0.5);
    }

    .status-dot.active {
      background: #4299e1;
      box-shadow: 0 0 10px rgba(66, 153, 225, 0.5);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .voice-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      justify-content: center;
    }

    .voice-btn {
      flex: 1;
      padding: 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .voice-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .voice-btn.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .voice-emoji {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .voice-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .voice-desc {
      font-size: 12px;
      opacity: 0.7;
    }

    .control-panel {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
    }

    .btn {
      flex: 1;
      padding: 18px 30px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .visualizer {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .visualizer-bars {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 100%;
    }

    .bar {
      width: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
      transition: height 0.1s;
    }

    .conversation {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .message {
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 8px;
      max-width: 80%;
    }

    .message.user {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message.assistant {
      background: white;
      color: #2d3748;
    }

    .message.interim {
      background: #e2e8f0;
      color: #718096;
      font-style: italic;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .metric-card {
      background: #f7fafc;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 12px;
      color: #718096;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .info-banner {
      background: #ebf8ff;
      border: 1px solid #90cdf4;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      color: #2c5282;
      font-size: 14px;
      line-height: 1.6;
    }

    .info-banner strong {
      color: #2b6cb0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ultra-Low Latency Voice Streaming</h1>
    <p class="subtitle">Deepgram STT ‚Üí Groq LLM ‚Üí MiniMax TTS</p>

    <!-- Status Card -->
    <div class="status-card">
      <div class="status-row">
        <span class="status-label">System Status</span>
        <span class="status-value">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Disconnected</span>
        </span>
      </div>
      <div class="status-row">
        <span class="status-label">Deepgram STT</span>
        <span class="status-value" id="sttStatus">Not connected</span>
      </div>
      <div class="status-row">
        <span class="status-label">Groq LLM</span>
        <span class="status-value" id="llmStatus">Ready</span>
      </div>
      <div class="status-row">
        <span class="status-label">MiniMax TTS</span>
        <span class="status-value" id="ttsStatus">Not connected</span>
      </div>
    </div>

    <!-- Voice Selector -->
    <div class="voice-selector">
      <div class="voice-btn active" data-voice="austyn">
        <div class="voice-emoji">üë®üèø</div>
        <div class="voice-name">Austyn</div>
        <div class="voice-desc">Male ‚Ä¢ Confident</div>
      </div>
      <div class="voice-btn" data-voice="joslyn">
        <div class="voice-emoji">üë©üèø</div>
        <div class="voice-name">Joslyn</div>
        <div class="voice-desc">Female ‚Ä¢ Warm</div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
      <button class="btn btn-primary" id="startBtn">
        <span>üéôÔ∏è</span> Start Conversation
      </button>
      <button class="btn btn-danger" id="stopBtn" disabled>
        <span>‚èπÔ∏è</span> Stop
      </button>
    </div>

    <!-- Audio Visualizer -->
    <div class="visualizer">
      <div class="visualizer-bars" id="visualizer"></div>
    </div>

    <!-- Conversation Display -->
    <div class="conversation" id="conversation">
      <div class="message assistant">
        üëã Hello! I'm ready to help you with your order. Click "Start Conversation" to begin speaking.
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-value" id="sttLatency">--</div>
        <div class="metric-label">STT Latency (ms)</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="llmLatency">--</div>
        <div class="metric-label">LLM Latency (ms)</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="ttsLatency">--</div>
        <div class="metric-label">TTS Latency (ms)</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="totalLatency">--</div>
        <div class="metric-label">Total Latency (ms)</div>
      </div>
    </div>

    <!-- Info Banner -->
    <div class="info-banner">
      <strong>How it works:</strong> This demo uses WebSocket streaming for all components.
      Deepgram transcribes your speech in real-time, Groq generates responses with sentence-level streaming,
      and MiniMax converts each sentence to speech immediately for ultra-low latency conversation.
      Try interrupting the AI while it's speaking!
    </div>
  </div>

  <!-- Include all required scripts -->
  <script src="config.js"></script>
  <script src="voice-activity-detection.js"></script>
  <script src="deepgram-stt.js"></script>
  <script src="groq-llm.js"></script>
  <script src="minimax-api.js"></script>
  <script src="voice-streaming-orchestrator.js"></script>

  <script>
    // Initialize orchestrator
    let orchestrator = null;
    let selectedVoice = 'austyn';

    // DOM elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const conversation = document.getElementById('conversation');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const sttStatus = document.getElementById('sttStatus');
    const llmStatus = document.getElementById('llmStatus');
    const ttsStatus = document.getElementById('ttsStatus');
    const visualizer = document.getElementById('visualizer');

    // Create visualizer bars
    for (let i = 0; i < 40; i++) {
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.height = '4px';
      visualizer.appendChild(bar);
    }

    // Voice selection
    document.querySelectorAll('.voice-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (orchestrator && orchestrator.isActive) return;

        document.querySelectorAll('.voice-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedVoice = btn.dataset.voice;
      });
    });

    // Initialize system
    async function initialize() {
      try {
        addMessage('system', 'Initializing ultra-low latency streaming system...');

        orchestrator = new VoiceStreamingOrchestrator(STREAMING_CONFIG);

        // Set up event listeners
        setupEventListeners();

        await orchestrator.initialize(selectedVoice);

        addMessage('system', '‚úÖ System initialized successfully!');
        statusText.textContent = 'Ready';
        sttStatus.textContent = 'Connected';
        ttsStatus.textContent = 'Connected';
        statusDot.classList.add('connected');

      } catch (error) {
        console.error('Initialization error:', error);
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      orchestrator.on('started', () => {
        statusText.textContent = 'Listening';
        statusDot.classList.add('active');
        startBtn.disabled = true;
        stopBtn.disabled = false;
      });

      orchestrator.on('stopped', () => {
        statusText.textContent = 'Ready';
        statusDot.classList.remove('active');
        startBtn.disabled = false;
        stopBtn.disabled = true;
      });

      orchestrator.on('interim_transcript', (text) => {
        updateInterimMessage(text);
      });

      orchestrator.on('user_message', (text) => {
        addMessage('user', text);
      });

      orchestrator.on('ai_sentence', (sentence) => {
        appendAIMessage(sentence);
      });

      orchestrator.on('ai_speech_start', () => {
        sttStatus.textContent = 'AI Speaking';
      });

      orchestrator.on('ai_speech_end', () => {
        sttStatus.textContent = 'Listening';
      });

      orchestrator.on('metrics', (metrics) => {
        updateMetrics(metrics);
      });

      orchestrator.on('volume', (volume) => {
        updateVisualizer(volume);
      });

      orchestrator.on('error', (error) => {
        console.error('Orchestrator error:', error);
        addMessage('system', `‚ùå Error: ${error.message || error}`);
      });
    }

    // Add message to conversation
    function addMessage(type, text) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      conversation.appendChild(msg);
      conversation.scrollTop = conversation.scrollHeight;
    }

    // Update interim transcript
    let interimElement = null;
    function updateInterimMessage(text) {
      if (!interimElement) {
        interimElement = document.createElement('div');
        interimElement.className = 'message interim';
        conversation.appendChild(interimElement);
      }
      interimElement.textContent = text;
      conversation.scrollTop = conversation.scrollHeight;
    }

    // Append to AI message
    let currentAIMessage = null;
    function appendAIMessage(text) {
      if (interimElement) {
        interimElement.remove();
        interimElement = null;
      }

      if (!currentAIMessage) {
        currentAIMessage = document.createElement('div');
        currentAIMessage.className = 'message assistant';
        conversation.appendChild(currentAIMessage);
      }

      currentAIMessage.textContent += (currentAIMessage.textContent ? ' ' : '') + text;
      conversation.scrollTop = conversation.scrollHeight;
    }

    // Update metrics display
    function updateMetrics(metrics) {
      document.getElementById('sttLatency').textContent = metrics.sttLatency || '--';
      document.getElementById('llmLatency').textContent = metrics.averageLLM || '--';
      document.getElementById('ttsLatency').textContent = metrics.ttsLatency || '--';
      document.getElementById('totalLatency').textContent = metrics.averageTotal || '--';
    }

    // Update visualizer
    function updateVisualizer(volume) {
      const bars = visualizer.querySelectorAll('.bar');
      const intensity = Math.min(volume * 100, 100);

      bars.forEach((bar, index) => {
        const height = Math.random() * intensity + 4;
        bar.style.height = `${height}px`;
      });
    }

    // Start conversation
    startBtn.addEventListener('click', async () => {
      if (!orchestrator) {
        await initialize();
      }

      currentAIMessage = null;
      await orchestrator.start();
      addMessage('system', 'üéôÔ∏è Listening... Start speaking!');
    });

    // Stop conversation
    stopBtn.addEventListener('click', () => {
      orchestrator.stop();
      currentAIMessage = null;
      addMessage('system', '‚èπÔ∏è Conversation stopped');
    });

    // Initialize on page load
    initialize();
  </script>
</body>
</html>
